<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fastmate - 관리하는 단식 </title>
    <link rel="icon" href="/favicon.ico" sizes="any">
     
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="manifest" href="/manifest.json?v=2025-09-06">
    <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script defer src="/firebase-init.js?v=2025.09.06-v8"></script>

<link rel="stylesheet" href="./styles.css">

</head>
<body>
  <script>
if (sessionStorage.getItem('oauthBusy') === '1') {
  document.body.classList.add('oauth-busy');
}
</script>
  <div id="splash-screen">
    <div class="splash-content">
      <h1 class="splash-title">fastmate</h1>
      <div class="spinner"></div>
    </div>
  </div>
  <main class="page-content">
    </main>
    <!-- 앱 메인 컨텐츠 -->
    <div class="container">
        <div id="userChip" class="user-chip" style="display:none">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <span id="userChipName">-</span>님
        </div>

        <h1 class="main-title">fastmate</h1>
        
        <div class="ring-wrap">
            <svg class="ring" viewBox="0 0 120 120">
     <defs>
    <linearGradient id="trackGrad"><stop stop-color="var(--gauge-track-color)"/></linearGradient>
    <linearGradient id="progGrad" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" stop-color="var(--gauge-start-color)"/>
        <stop offset="100%" stop-color="var(--primary-color)"/>
    </linearGradient>
    <linearGradient id="overtimeGrad" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" stop-color="#FF690B"/>
        <stop offset="100%" stop-color="var(--gauge-start-color)"/>
    </linearGradient>
</defs>
                <circle cx="60" cy="60" r="54" stroke="url(#trackGrad)" stroke-width="12" fill="none"/>
                <circle id="progressArc" cx="60" cy="60" r="54" stroke="url(#progGrad)" stroke-width="12" fill="none" stroke-linecap="round" pathLength="100" stroke-dasharray="0 100" transform="rotate(-90 60 60)"/>
            </svg>
            <div class="timer-display">
                <div class="label">남은 시간</div>
                <div id="remainingTime" class="time">00:00:00</div>
            </div>
        </div>

        <div id="status-message" class="status-message">단식 계획을 선택하고 시작하세요.</div>

        <div class="time-info">
            <div id="startTimeBox" class="time-box" title="클릭하여 시간 변경">
                <span class="label">시작 시간</span>
                <span id="startTimeValue" class="value">-</span>
                <svg class="edit-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
            </div>
            <div class="time-box">
                <span class="label">종료 예정</span>
                <span id="endTimeValue" class="value">-</span>
            </div>
        </div>
        <div id="timePickerModal" style="display:none; position:fixed; inset:0; z-index:1900; background:rgba(0,0,0,.5); align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
        <div class="time-picker-content">
            <h3 class="onb-title">시작 시간 선택</h3>
            <div class="date-selector">
                <button id="dayBeforeBtn" type="button" class="date-btn">어제</button>
                <button id="todayBtn" type="button" class="date-btn active">오늘</button>
            </div>
            <div class="time-selector">
                <select id="ampmSelect">
                    <option>AM</option>
                    <option>PM</option>
                </select>
                <select id="hourSelect"></select>
                <span>:</span>
                <select id="minuteSelect"></select>
            </div>
            <div class="onb-actions">
                <button type="button" data-close="timePickerModal" class="onb-btn onb-ghost">취소</button>
                <button id="saveTimeBtn" type="button" class="onb-btn onb-primary">확인</button>
            </div>
        </div>
    </div>
        <div id="completionOverlay" class="completion-overlay">
        <div class="completion-content">
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <h2>목표 달성!</h2>
            <p>축하합니다! 성공적으로 단식을 마쳤습니다.</p>
        </div>
    </div>
    
        <div id="salt-tip" class="salt-tip">💡 <strong>팁:</strong> 48시간 이상 장기 단식 시에는 미네랄 보충을 위해 약간의 소금을 섭취하는 것이 좋습니다.</div>

        <div class="controls">
            <select id="fastingModelSelect">
              <option value="8">8:16 (8시간 단식,야식끊기)</option>  
              <option value="12">12:12 (12시간 단식,초보)</option>  
              <option value="16">16:8 (16시간 단식,인기)</option>
                <option value="18">18:6 (18시간 단식,인기)</option>
                <option value="20">20:4 (20시간 단식,고급)</option>
                <option value="24">24시간 (1일 단식,고급)</option>
                <option value="36">36시간(1.5일 단식,고급)</option>
                <option value="48">48시간 (2일 단식,고급)</option>
                <option value="72">72시간 (3일 단식,고급)</option>
            </select>
            <div class="button-group">
                <button id="startBtn" class="start-btn">단식 시작</button>
                <button id="stopBtn" class="stop-btn">단식 종료</button>
            </div>
        </div>

        <div class="bottom-nav">
               <button class="nav-btn" id="weightBtn">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3L2 9l10 6 10-6-10-6zM2 15l10 6 10-6"></path><path d="M2 9v6"></path><path d="M22 9v6"></path><path d="M12 21v-6"></path>
        </svg>
        <span>체중 기록</span>
            </button>
            <button class="nav-btn" id="bloodSugarBtn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                <span>혈당 기록</span>
            </button>
            <button class="nav-btn" id="ketoneBtn">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M12 2v20"/><path d="M7 7h10"/><path d="M7 17h10"/></svg>
  <span>케톤 기록</span>
</button>

<button class="nav-btn" id="exerciseBtn">
  <svg xmlns="http://www.w3.org/2000/svg" 
       viewBox="0 0 24 24" fill="none" 
       stroke="currentColor" stroke-width="2" 
       stroke-linecap="round" stroke-linejoin="round">
    <path d="M6 6v12M18 6v12"/>
    <path d="M3 10v4M21 10v4"/>
    <path d="M6 12h12"/>
  </svg>
  <span>운동 기록</span>
</button>
        </div>

       
        <!-- 체중 기록 모달 -->
<div id="weightModal" style="display:none; position:fixed; inset:0; z-index:1900; background:rgba(0,0,0,.5); align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
  <div style="width:100%; max-width:420px; background:var(--card-bg); border:1px solid var(--border-color); border-radius:16px; box-shadow:0 16px 60px rgba(0,0,0,.2); padding:24px;">
    <h3 class="onb-title" style="margin-bottom:8px;">체중 기록</h3>
    <p class="onb-desc">현재 체중(kg)을 입력해주세요.</p>
    <input id="weightInput" class="onb-input" type="number" step="0.1" min="0" placeholder="예. 65.5" />
    <div class="onb-actions" style="margin-top:20px;">
      <button type="button" data-close="weightModal" class="onb-btn onb-ghost">취소</button>
      <button id="saveWeightBtn" type="button" class="onb-btn onb-primary">저장</button>
    </div>
  </div>
</div>

       
       
        <!-- 케톤 기록 모달 -->
<div id="ketoneModal" style="display:none; position:fixed; inset:0; z-index:1900; background:rgba(0,0,0,.5); align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
  <div style="width:100%; max-width:420px; background:var(--card-bg); border:1px solid var(--border-color); border-radius:16px; box-shadow:0 16px 60px rgba(0,0,0,.2); padding:24px;">
    <h3 class="onb-title" style="margin-bottom:8px;">케톤 기록</h3>
    <p class="onb-desc">케톤 수치(mmOL/L)를 입력해주세요.</p>
    <input id="ketoneInput" class="onb-input" type="number" step="0.1" min="0" placeholder="예. 1.2" />
    <div class="onb-actions" style="margin-top:20px;">
      <button type="button" data-close="ketoneModal" class="onb-btn onb-ghost">취소</button>
      <button id="saveKetoneBtn" type="button" class="onb-btn onb-primary">저장</button>
    </div>
  </div>
</div>


    <!-- 혈당 기록 모달 -->
<div id="bloodSugarModal" style="display:none; position:fixed; inset:0; z-index:1900; background:rgba(0,0,0,.5); align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
  <div style="width:100%; max-width:420px; background:var(--card-bg); border:1px solid var(--border-color); border-radius:16px; box-shadow:0 16px 60px rgba(0,0,0,.2); padding:24px;">
    <h3 class="onb-title" style="margin-bottom:8px;">혈당 기록</h3>
    <p class="onb-desc">혈당 수치와 측정 시간을 입력해주세요.</p>
    
    <label class="onb-label" style="margin-top:20px; margin-bottom: 5px; text-align: left;">혈당 (mg/dL)</label>
    <input id="bloodSugarInput" class="onb-input" type="number" step="1" min="1" placeholder="예. 92" />

    <label class="onb-label" style="margin-top:15px; margin-bottom: 5px; text-align: left;">측정 시간</label>
    <input id="bloodSugarTimestampInput" class="onb-input" type="datetime-local" />

    <div class="onb-actions" style="margin-top:20px;">
      <button type="button" data-close="bloodSugarModal" class="onb-btn onb-ghost">취소</button>
      <button id="saveBloodSugarBtn" type="button" class="onb-btn onb-primary">저장</button>
    </div>
  </div>
</div>

<!-- 운동 기록 모달 -->
<div id="exerciseModal" style="display:none; position:fixed; inset:0; z-index:1900; background:rgba(0,0,0,.5); align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
  <div style="width:100%; max-width:420px; background:var(--card-bg); border:1px solid var(--border-color); border-radius:16px; box-shadow:0 16px 60px rgba(0,0,0,.2); padding:24px;">
    <h3 class="onb-title" style="margin-bottom:8px;">운동 기록</h3>
    <p class="onb-desc">운동 종류와 시간을 입력해주세요.</p>

    <!-- 기존 태그 스타일 재사용 -->
    <div id="exerciseType" class="tag-cloud" style="margin-bottom:12px;">
      <button type="button" class="tag" data-value="걷기">걷기</button>
      <button type="button" class="tag" data-value="달리기">달리기</button>
      <button type="button" class="tag" data-value="요가">요가</button>
      <button type="button" class="tag" data-value="근력운동">근력운동</button>
      <button type="button" class="tag" data-value="수영">수영</button>
      <button type="button" class="tag" data-value="자전거">자전거</button>
      <button type="button" class="tag" data-value="등산">등산</button>
      <button type="button" class="tag" data-value="줄넘기">줄넘기</button>
      <button type="button" class="tag" data-value="필라테스">필라테스</button>
      <button type="button" class="tag" data-value="댄스">댄스</button>
      <button type="button" class="tag" data-value="등산">등산</button>
      <button type="button" class="tag" data-value="타바타">타바타</button>
      <button type="button" class="tag" data-value="계단">계단운동</button>
      <button type="button" class="tag" data-value="발레">발레</button>
      <button type="button" class="tag" data-value="테니스">테니스</button>
      <button type="button" class="tag" data-value="기타">기타</button>
    </div>

    <input id="exerciseDuration" class="onb-input" type="number" min="1" placeholder="운동 시간(분)" style="margin-bottom:10px;" />
    <input id="exerciseCalories" class="onb-input" type="number" min="0" placeholder="소모 칼로리(kcal, 선택)" />

    <div class="onb-actions" style="margin-top:20px;">
      <button type="button" data-close="exerciseModal" class="onb-btn onb-ghost">취소</button>
      <button id="saveExerciseBtn" type="button" class="onb-btn onb-primary">저장</button>
    </div>
  </div>
</div>


        <footer class="app-footer">
            <a href="#" id="privacyPolicyLink">개인정보처리방침</a>
            <p>© 2025 2e-studio. All rights reserved.</p>
             <!-- ▼▼▼ FAQ 링크 추가 ▼▼▼ -->
    <p class="faq-link">
      <a href="https://www.notion.so/maenglionworld/FASTMATE-FAQ-256bcdc037cd80de887dfb24a7cae5a1?source=copy_link" target="_blank" rel="noopener noreferrer">
        이용이 어려우신가요? (FAQ)
      </a>
    </p>
    <!-- ▲▲▲ FAQ 링크 추가 ▲▲▲ -->
        </footer>
    </div>
    
    <!-- 온보딩 모달 (화면 전체를 덮는 배경 포함) -->
    <div id="appShield">
        <div id="onboardingModal">
            <h3 class="onb-title">처음 오셨군요! 👋</h3>
            <p class="onb-desc">fastmate의 모든 기능을 사용하기 위해 닉네임과 가입 목적을 알려주세요.</p>
    
            <label class="onb-label" for="onbNickname">닉네임</label>
            <input id="onbNickname" class="onb-input" type="text" placeholder="예.건강한 라이언" />
    
            <label class="onb-label" style="margin-top: 20px;">가입 목적 (1개 이상 선택)</label>
            <div id="onbGoals" class="tag-cloud">
                <button type="button" class="tag" data-value="체중관리">체중관리</button>
                <button type="button" class="tag" data-value="혈당 관리">혈당관리</button>
                <button type="button" class="tag" data-value="자가포식(오토파지)">자가포식(오토파지)</button>
                <button type="button" class="tag" data-value="위장휴식·소화개선">위장휴식·소화개선</button>
                <button type="button" class="tag" data-value="에너지·집중력 개선">에너지·집중력 개선</button>
                <button type="button" class="tag" data-value="기타">기타</button>
            </div>
    
            <div class="onb-actions">
                <button id="onbCancel" type="button" class="onb-btn onb-ghost">나중에 할게요</button>
                <button id="onbSave" type="button" class="onb-btn onb-primary">저장하고 시작</button>
            </div>
        </div>
    </div>

    <!-- Toast Alert -->
    <div id="toast"></div>




<script>
document.addEventListener('DOMContentLoaded', () => {
  // ===== 0) Firebase 핸들 =====
  const app = window.fastmateApp || {};
  const auth = app.auth;
  const db   = app.db;
  const getUserDoc = app.getUserDoc || (async () => null);

  // ===== 1) DOM 캐시 =====
  const userChip        = document.getElementById('userChip');
  const userChipName    = document.getElementById('userChipName');
  const progressArc     = document.getElementById('progressArc');
  const completionOverlay = document.getElementById('completionOverlay');
  const remainingTimeEl = document.getElementById('remainingTime');
  const statusMessage   = document.getElementById('status-message');
  const saltTip         = document.getElementById('salt-tip');
  const startBtn        = document.getElementById('startBtn');
  const stopBtn         = document.getElementById('stopBtn');
  const modelSelect     = document.getElementById('fastingModelSelect');
  const startTimeBox    = document.getElementById('startTimeBox');
  const startTimeValue  = document.getElementById('startTimeValue');
  const endTimeValue    = document.getElementById('endTimeValue');

  // 공용 시간선택 모달
  const timePickerModal = document.getElementById('timePickerModal');
  const timePickerTitle = timePickerModal?.querySelector('.onb-title');
  const dayBeforeBtn    = document.getElementById('dayBeforeBtn');
  const todayBtn        = document.getElementById('todayBtn');
  const hourSelect      = document.getElementById('hourSelect');
  const minuteSelect    = document.getElementById('minuteSelect');
  const ampmSelect      = document.getElementById('ampmSelect');
  const saveTimeBtn     = document.getElementById('saveTimeBtn');

  // 선택 확인 모달(없으면 confirm 사용)
  const confirmChangeModal = document.getElementById('confirmChangeModal');
  const confirmMessage     = document.getElementById('confirmMessage');
  const confirmYesBtn      = document.getElementById('confirmYesBtn');
  const confirmNoBtn       = document.getElementById('confirmNoBtn');

  // 기록 모달/컨트롤
  const bloodSugarBtn     = document.getElementById('bloodSugarBtn');
  const ketoneBtn         = document.getElementById('ketoneBtn');
  const exerciseBtn       = document.getElementById('exerciseBtn');
  const bloodSugarModal   = document.getElementById('bloodSugarModal');
  const saveBloodSugarBtn = document.getElementById('saveBloodSugarBtn');
  const bloodSugarInput   = document.getElementById('bloodSugarInput');
  const ketoneModal       = document.getElementById('ketoneModal');
  const saveKetoneBtn     = document.getElementById('saveKetoneBtn');
  const ketoneInput       = document.getElementById('ketoneInput');
  const exerciseModal     = document.getElementById('exerciseModal');
  const exerciseTypeWrap  = document.getElementById('exerciseType');
  const exerciseDuration  = document.getElementById('exerciseDuration');
  const exerciseCalories  = document.getElementById('exerciseCalories');
  const saveExerciseBtn   = document.getElementById('saveExerciseBtn');
  const weightBtn         = document.getElementById('weightBtn');
  const weightModal       = document.getElementById('weightModal');
  const saveWeightBtn     = document.getElementById('saveWeightBtn');
  const weightInput       = document.getElementById('weightInput');
  const privacyPolicyLink = document.getElementById('privacyPolicyLink');
  const toast             = document.getElementById('toast');

  // ===== 2) 상태 =====
  let currentUser = null;
  let fastingInterval = null;
  let fastingState = 'idle'; // 'idle'|'running'
  let targetHours = 16;
  let selectedStartTime = new Date();
  let pendingTargetHours = null;
  let completionFired = false;
  let toastTimeout = null;

  // 타임피커
  let timePickerMode = null;   // 'start' | 'end' | null
  let timePickerUsed = false;  // 시작시간을 명시 선택했는지

  const milestones = { 10:false, 25:false, 50:false, 75:false, 90:false, 110:false, 120:false, 150:false, 200:false };

  // 타임피커 z-index 보정
(() => {

  const style = document.createElement('style');
  style.textContent = `
    #timePickerModal { z-index:9999 !important; }
    #timePickerModal .time-picker-content { transform:none !important; }
    #timePickerModal select {
        pointer-events:auto;
        -webkit-appearance:menulist !important;
        appearance:auto !important;
        background-image:none !important;
    }
    /* 커스텀 화살표/오버레이 제거 (있을 경우 모두 무력화) */
    #timePickerModal .time-selector::after,
    #timePickerModal .time-selector::before,
    #timePickerModal .time-selector .chevron,
    #timePickerModal .time-selector .select-arrow,
    #timePickerModal select::-ms-expand {
        display:none !important;
        content:none !important;
    }
    #timePickerModal .time-selector {
        position:static !important;
        background-image:none !important;
    }
    #timePickerModal .time-selector .chevron,
    #timePickerModal .time-selector .select-arrow {
        pointer-events:none !important; /* 터치 가로채기 방지 */
    }
  `;
  document.head.appendChild(style);
})();


  // ===== 3) 유틸 =====
  function showToast(msg) {
    if (!toast) return;
    clearTimeout(toastTimeout);
    toast.textContent = msg;
    toast.classList.add('show');
    toastTimeout = setTimeout(() => toast.classList.remove('show'), 1800);
  }

  function setUserChip(name) {
    if (!userChip || !userChipName) return;
    userChipName.textContent = (name && String(name).trim()) || '사용자';
    userChip.style.display = 'flex';
  }

  function getSignedInUser() {
    return currentUser || auth?.currentUser || null;
  }

  function updateUIState() {
    const running = fastingState === 'running';
    if (startBtn) {
      startBtn.disabled = running;
      startBtn.textContent = running ? '단식중' : '단식 시작';
      startBtn.style.backgroundColor = running ? 'var(--gauge-start-color)' : 'var(--primary-color)';
      startBtn.style.color = running ? '#333' : '#fff';
    }
    if (stopBtn) {
      stopBtn.disabled = !running;
      stopBtn.style.opacity = running ? '1' : '0.5';
    }
  }

  function updateSelectOptions() {
    if (!modelSelect) return;
    modelSelect.classList.add('is-fasting');
    const options = modelSelect.options;
    for (let i = 0; i < options.length; i++) {
      const opt = options[i];
      if (!opt.dataset.originalText) opt.dataset.originalText = opt.textContent;
      if (opt.value == targetHours) {
        opt.textContent = `${opt.dataset.originalText} (진행중)`;
        opt.classList.add('is-running');
      } else {
        opt.textContent = opt.dataset.originalText;
        opt.classList.remove('is-running');
      }
    }
  }

  function resetSelectOptions() {
    if (!modelSelect) return;
    modelSelect.classList.remove('is-fasting');
    const options = modelSelect.options;
    for (let i = 0; i < options.length; i++) {
      const opt = options[i];
      if (opt.dataset.originalText) opt.textContent = opt.dataset.originalText;
      opt.classList.remove('is-running');
    }
  }

  function updateTimeDisplays() {
    const start = selectedStartTime;
    const duration = fastingState === 'running'
      ? parseFloat(targetHours)
      : parseInt(modelSelect?.value || targetHours, 10);
    const end = new Date(start.getTime() + duration * 3600000);
    const fmt = (d) =>
      `${d.getMonth()+1}/${d.getDate()} ${d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}`;
    if (startTimeValue) startTimeValue.textContent = fmt(start);
    if (endTimeValue)   endTimeValue.textContent   = fmt(end);
  }

  function checkMilestones() {
    const now = new Date();
    const elapsed = now - selectedStartTime;
    const target  = parseFloat(targetHours) * 3600000;
    const actualProgress = (elapsed / target) * 100;

    const messages = {
      10:  "시작이 반! 물 한 잔으로 몸을 깨워주세요. 💧",
      25:  "25% 달성! 순조롭게 진행 중이에요.",
      50:  "절반이나 왔어요! 정말 대단해요. 시원한 물 한 잔 잊지 마세요! 💧",
      75:  "75% 돌파! 거의 다 왔습니다. 조금만 더 힘내세요!",
      90:  "90% 돌파! 목표가 바로 눈앞에 있어요. 화이팅! 💧",
      110: "110% 초과 달성! 몸이 보내는 신호에 귀를 기울여 주세요.",
      120: "120% 초과 달성! 정말 대단한 의지입니다!",
      150: "150% 초과 달성! 새로운 기록을 쓰고 계시는군요!",
      200: "200% 달성! 컨디션 조절은 필수입니다. 충분한 휴식을 잊지 마세요."
    };

    Object.keys(milestones).forEach((p) => {
      const pi = parseInt(p, 10);
      if (actualProgress >= pi && !milestones[p]) {
        showToast(messages[p]);
        milestones[p] = true;
      }
    });
  }

  function updateTimer() {
    const now = new Date();
    const elapsed = now - selectedStartTime;
    const target  = parseFloat(targetHours) * 3600000;
    const progress = Math.min((elapsed / target) * 100, 100);

    const timerLabel = document.querySelector('.timer-display .label');

    // 비어있으면 1회 채우기
    if ((startTimeValue?.textContent === '-' || endTimeValue?.textContent === '-') && selectedStartTime) {
      const fmt = (d) =>
        `${d.getMonth()+1}/${d.getDate()} ${d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}`;
      startTimeValue.textContent = fmt(selectedStartTime);
      endTimeValue.textContent = fmt(new Date(selectedStartTime.getTime() + (parseFloat(targetHours) * 3600000)));
    }

    if (elapsed < target) {
      // 목표 전
      if (timerLabel) timerLabel.textContent = '남은 시간';
      if (progressArc) progressArc.setAttribute('stroke', 'url(#progGrad)');
      const remain = target - elapsed;
      const h = Math.floor(remain / 3600000);
      const m = Math.floor((remain % 3600000) / 60000);
      const s = Math.floor((remain % 60000) / 1000);
      if (remainingTimeEl) remainingTimeEl.textContent =
        `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      if (statusMessage) {
        statusMessage.innerHTML =
          `<span style="color: var(--primary-color); font-weight: 700;">${targetHours}시간</span> 단식 진행중...`;
      }
    } else {
      // 목표 초과
      if (timerLabel) timerLabel.textContent = '초과 시간';
      if (progressArc) progressArc.setAttribute('stroke', 'url(#overtimeGrad)');
      const overtime = elapsed - target;
      const h = Math.floor(overtime / 3600000);
      const m = Math.floor((overtime % 3600000) / 60000);
      const s = Math.floor((overtime % 60000) / 1000);
      if (remainingTimeEl) remainingTimeEl.textContent =
        `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      if (statusMessage) statusMessage.textContent = '목표 달성! 대단해요!';
    }

    if (progressArc) progressArc.style.strokeDasharray = `${progress} 100`;
    checkMilestones();

    if (progress >= 100 && !completionFired) {
      completionFired = true;
      if (completionOverlay) {
        completionOverlay.classList.add('show');
        setTimeout(() => completionOverlay.classList.remove('show'), 4000);
      }
    }
  }

  function initializeTime() {
    selectedStartTime = new Date();
    updateTimeDisplays();
    initializeTimePicker(); // 안전: 항상 와이어
  }

  // ===== 4) 모델 변경 =====
  function handleModelChange(e) {
    const newTarget = parseInt(e.target.value, 10);
    if (fastingState === 'running' && newTarget !== targetHours) {
      pendingTargetHours = newTarget;
      if (confirmChangeModal && confirmMessage) {
        confirmMessage.textContent = `단식 목표를 ${targetHours}시간에서 ${newTarget}시간으로 변경하시겠습니까?`;
        confirmChangeModal.style.display = 'flex';
      } else {
        if (confirm(`단식 목표를 ${targetHours}시간 → ${newTarget}시간으로 변경할까요?`)) {
          targetHours = newTarget;
          modelSelect.value = targetHours;
          updateTimeDisplays(); updateTimer();
          if (saltTip) saltTip.style.display = targetHours >= 48 ? 'block' : 'none';
          showToast('단식 목표가 변경되었습니다.');
        } else {
          modelSelect.value = targetHours;
        }
      }
    } else if (fastingState !== 'running') {
      targetHours = newTarget;
      updateTimeDisplays();
    }
  }

  // ===== 5) 타임피커 =====
  let timePickerWired = false;

  function ensureTimepickerOptions() {
    if (hourSelect && hourSelect.options.length === 0) {
      for (let i = 1; i <= 12; i++) {
        const o = document.createElement('option');
        o.value = String(i);
        o.textContent = String(i);
        hourSelect.appendChild(o);
      }
    }
    if (minuteSelect && minuteSelect.options.length === 0) {
      for (let i = 0; i < 60; i++) {
        const o = document.createElement('option');
        o.value = String(i);
        o.textContent = String(i).padStart(2,'0');
        minuteSelect.appendChild(o);
      }
    }
  }

  function initializeTimePicker() {
    if (!timePickerModal || timePickerWired) return;
    timePickerWired = true;

    [ampmSelect, hourSelect, minuteSelect].forEach((sel) => {
      if (!sel) return;
      sel.style.backgroundImage = 'none';
      sel.style.appearance = 'auto';
      sel.style.webkitAppearance = 'menulist';
      sel.disabled = false;
      sel.style.pointerEvents = 'auto';
      sel.addEventListener('click', (e) => e.stopPropagation());
      sel.addEventListener('touchstart', (e) => e.stopPropagation(), { passive: true });
      sel.addEventListener('mousedown', (e) => e.stopPropagation());
    });

    ensureTimepickerOptions();

    startTimeBox?.addEventListener('click', () => openTimePicker('start'));

    dayBeforeBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      dayBeforeBtn.classList.add('active');
      todayBtn.classList.remove('active');
    });
    todayBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      todayBtn.classList.add('active');
      dayBeforeBtn.classList.remove('active');
    });

    saveTimeBtn?.addEventListener('click', async (e) => {
      e.stopPropagation();
      ensureTimepickerOptions();

      const h12  = parseInt(hourSelect?.value ?? '', 10);
      const mm   = parseInt(minuteSelect?.value ?? '', 10);
      const ampm = ampmSelect?.value;
      if (Number.isNaN(h12) || Number.isNaN(mm) || !ampm) {
        console.warn('[timepicker] invalid', { h12, mm, ampm });
        return showToast('시간을 다시 선택해주세요.');
      }

      let hour = h12 % 12;
      if (ampm === 'PM') hour += 12;

      const picked = new Date();
      if (dayBeforeBtn?.classList.contains('active')) picked.setDate(picked.getDate() - 1);
      picked.setHours(hour, mm, 0, 0);

      if (timePickerMode === 'start') {
        timePickerUsed = true;
        selectedStartTime = picked;
        updateTimeDisplays();
        timePickerModal.style.display = 'none';

        if (fastingState === 'running') {
          if (!currentUser) return showToast('사용자 정보가 없습니다. 다시 시도해주세요.');
          try {
            await db.collection('users').doc(currentUser.uid).set({
              currentFasting: { startTime: selectedStartTime, targetHours }
            }, { merge: true });
            updateTimer();
            showToast('진행 중인 단식의 시작 시간을 변경했습니다.');
          } catch (err) {
            console.error('Error updating start time:', err);
            showToast('시간 변경에 실패했습니다.');
          }
        }
      } else if (timePickerMode === 'end') {
        if (picked < selectedStartTime) return showToast('종료 시간은 시작 시간 이후여야 합니다.');
        timePickerModal.style.display = 'none';
        finalizeStopFasting(picked);
      } else {
        console.warn('[timepicker] mode is null');
        showToast('잠시 후 다시 시도해주세요.');
      }
    });

    // 모달 바깥 클릭 시 닫기
    window.addEventListener('click', (e) => {
      if (e.target === timePickerModal) timePickerModal.style.display = 'none';
    });
  }

  function openTimePicker(mode /* 'start'|'end' */) {
    if (!timePickerModal) return;
    timePickerMode = mode;

    ensureTimepickerOptions();
    timePickerModal.style.zIndex = '9999';
    timePickerModal.style.display = 'flex';

    const title = (mode === 'start') ? '시작 시간 선택' : '종료 시간 선택';
    const base  = (mode === 'start') ? (selectedStartTime || new Date()) : new Date();

    let h = base.getHours();
    const ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12; h = h ? h : 12;

    if (ampmSelect)   ampmSelect.value = ampm;
    if (hourSelect)   hourSelect.value = String(h);
    if (minuteSelect) minuteSelect.value = String(base.getMinutes());

    todayBtn?.classList.add('active');
    dayBeforeBtn?.classList.remove('active');

    if (timePickerTitle) timePickerTitle.textContent = title;
  }

  // ===== 6) 시작/종료 =====
  async function startFasting() {
    if (fastingState === 'running') return showToast('이미 단식이 진행 중입니다.');
    if (!getSignedInUser()) return showToast('로그인이 필요합니다.');

    if (!timePickerUsed) selectedStartTime = new Date();

    fastingState = 'running';
    targetHours = parseFloat(modelSelect.value || targetHours);

    updateTimeDisplays();
    updateUIState();
    updateSelectOptions();

    if (fastingInterval) clearInterval(fastingInterval);
    fastingInterval = setInterval(updateTimer, 1000);
    updateTimer();

    try {
      await db.collection('users').doc(currentUser.uid).set({
        currentFasting: { startTime: selectedStartTime, targetHours }
      }, { merge: true });
      showToast(`${targetHours}시간 단식을 시작합니다!`);
    } catch (err) {
      console.error('Firestore 저장 실패:', err);
      showToast('단식 시작 저장에 실패했습니다.');
      clearInterval(fastingInterval);
      fastingState = 'idle';
      updateUIState();
      resetSelectOptions();
    } finally {
      timePickerUsed = false;
    }
  }

  function openEndTimePickerForStop() {
    if (fastingState !== 'running') return showToast('시작된 단식이 없습니다.');
    openTimePicker('end');
  }

  async function finalizeStopFasting(endDate /* Date */) {
    if (fastingState === 'idle') return showToast('시작된 단식이 없습니다.');

    clearInterval(fastingInterval);
    fastingState = 'idle';

    if (!currentUser) {
      if (progressArc)     progressArc.style.strokeDasharray = '0 100';
      if (remainingTimeEl) remainingTimeEl.textContent = '00:00:00';
      if (statusMessage)   statusMessage.textContent = '단식 계획을 선택하고 시작하세요.';
      if (saltTip)         saltTip.style.display = 'none';
      initializeTime();
      updateUIState();
      resetSelectOptions();
      return showToast('사용자 정보가 없어 기록 저장을 건너뜁니다.');
    }

    const record = {
      startTime: selectedStartTime,
      endTime: endDate || new Date(),
      targetHours: parseFloat(targetHours),
      actualDurationHours: ((endDate || new Date()) - selectedStartTime) / 3600000
    };

    try {
      await db.collection('users').doc(currentUser.uid)
        .collection('fastingHistory').add({
          startTime: record.startTime,
          endTime: record.endTime,
          targetHours: record.targetHours,
          actualDurationHours: record.actualDurationHours,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

      await db.collection('users').doc(currentUser.uid).update({
        currentFasting: firebase.firestore.FieldValue.delete()
      });
    } catch (e) {
      console.error('단식 기록 저장/상태 삭제 실패:', e);
      showToast('기록 저장에 실패했습니다. 다시 시도해주세요.');
    }

    if (progressArc)     progressArc.style.strokeDasharray = '0 100';
    if (remainingTimeEl) remainingTimeEl.textContent = '00:00:00';
    if (statusMessage)   statusMessage.textContent = '단식 계획을 선택하고 시작하세요.';
    if (saltTip)         saltTip.style.display = 'none';

    initializeTime();
    updateUIState();
    resetSelectOptions();
    showToast('단식을 종료했습니다. 수고하셨습니다!');
  }

  // ===== 7) 이벤트 와이어 =====
  let eventsWired = false;
  function wireEventsOnce() {
    if (eventsWired) return;
    eventsWired = true;

    startBtn?.addEventListener('click', startFasting);
    stopBtn?.addEventListener('click', openEndTimePickerForStop);
    modelSelect?.addEventListener('change', handleModelChange);

    userChip?.addEventListener('click', () => { window.location.href = 'mypage.html'; });

    confirmYesBtn?.addEventListener('click', () => {
      if (pendingTargetHours == null) return;
      targetHours = pendingTargetHours; pendingTargetHours = null;
      modelSelect.value = targetHours;
      updateTimeDisplays(); updateTimer();
      if (saltTip) saltTip.style.display = targetHours >= 48 ? 'block' : 'none';
      showToast('단식 목표가 변경되었습니다.');
      confirmChangeModal.style.display = 'none';
    });
    confirmNoBtn?.addEventListener('click', () => {
      if (modelSelect) modelSelect.value = targetHours;
      confirmChangeModal.style.display = 'none';
    });

    // 공통 모달 닫기
    document.addEventListener('click', (e) => {
      const closeId = e.target?.getAttribute?.('data-close');
      if (closeId) {
        const el = document.getElementById(closeId);
        if (el) el.style.display = 'none';
      }
    });

    window.addEventListener('click', (e) => {
      [bloodSugarModal, ketoneModal, exerciseModal, weightModal]
        .filter(Boolean)
        .forEach(m => { if (e.target === m) m.style.display = 'none'; });
    });

    // ===== 기록: 체중 =====
    weightBtn?.addEventListener('click', () => weightModal && (weightModal.style.display='flex'));
    saveWeightBtn?.addEventListener('click', async () => {
      const v = parseFloat(weightInput?.value);
      if (!v || v <= 0) return showToast('올바른 체중을 입력하세요.');
      const user = getSignedInUser(); if (!user) return showToast('로그인이 필요합니다.');
      try {
        await db.collection('users').doc(user.uid).collection('measurements').doc('weight')
          .collection('items').add({ date: new Date(), value: v, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      } catch (e) {
        console.error('save weight failed:', e);
        showToast('서버 저장 실패(체중)… 잠시 후 다시 시도해주세요.');
      }
      weightInput.value = '';
      weightModal.style.display = 'none';
      showToast('체중이 저장되었습니다.');
    });

    // ===== 기록: 혈당 =====
    bloodSugarBtn?.addEventListener('click', () => {
      if (!bloodSugarModal) return;
      bloodSugarModal.style.display = 'flex';
      const t = document.getElementById('bloodSugarTimestampInput');
      if (t) {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        t.value = now.toISOString().slice(0, 16);
      }
    });

    saveBloodSugarBtn?.addEventListener('click', async () => {
      const v = parseFloat(bloodSugarInput?.value);
      if (!v || v <= 0) return showToast('올바른 혈당 수치를 입력하세요.');
      const t = document.getElementById('bloodSugarTimestampInput');
      if (!t?.value) return showToast('측정 시간을 선택해주세요.');
      const recordDate = new Date(t.value);
      const user = getSignedInUser(); if (!user) return showToast('로그인이 필요합니다.');
      saveLocalList('bloodSugarData', { date: recordDate.toISOString(), value: v });
      try {
        await db.collection('users').doc(user.uid).collection('measurements').doc('bloodSugar')
          .collection('items').add({ date: recordDate, value: v, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      } catch (e) {
        console.error('save blood sugar failed:', e);
        showToast('서버 저장 실패(혈당)… 잠시 후 다시 시도해주세요.');
      }
      bloodSugarInput.value = '';
      bloodSugarModal.style.display = 'none';
      showToast('혈당 수치가 저장되었습니다.');
    });

    // ===== 기록: 케톤 =====
    ketoneBtn?.addEventListener('click', () => ketoneModal && (ketoneModal.style.display='flex'));
    saveKetoneBtn?.addEventListener('click', async () => {
      const v = parseFloat(ketoneInput?.value);
      if (v == null || isNaN(v) || v < 0) return showToast('올바른 케톤 수치를 입력하세요.');
      const user = getSignedInUser(); if (!user) return showToast('로그인이 필요합니다.');
      saveLocalList('ketoneData', { date: new Date().toISOString(), value: v });
      try {
        await db.collection('users').doc(user.uid).collection('measurements').doc('ketone')
          .collection('items').add({ date: new Date(), value: v, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      } catch (e) {
        console.error('save ketone failed:', e);
        showToast('서버 저장 실패(케톤)… 잠시 후 다시 시도해주세요.');
      }
      ketoneInput.value = '';
      ketoneModal.style.display = 'none';
      showToast('케톤 수치가 저장되었습니다.');
    });

    // ===== 기록: 운동 =====
    exerciseBtn?.addEventListener('click', () => exerciseModal && (exerciseModal.style.display='flex'));
    exerciseTypeWrap?.addEventListener('click', (e) => {
      if (!e.target.classList.contains('tag')) return;
      const prev = exerciseTypeWrap.querySelector('.tag.active');
      if (prev) prev.classList.remove('active');
      e.target.classList.add('active');
    });
    saveExerciseBtn?.addEventListener('click', async () => {
      const sel = exerciseTypeWrap?.querySelector('.tag.active');
      const duration = parseInt(exerciseDuration?.value,10);
      const calories = exerciseCalories?.value === '' ? null : parseInt(exerciseCalories.value,10);
      if (!sel) return showToast('운동 종류를 선택하세요.');
      if (!duration || duration<=0) return showToast('올바른 운동 시간을 입력하세요.');
      if (calories !== null && calories < 0) return showToast('칼로리는 0 이상으로 입력하세요.');
      const user = getSignedInUser(); if (!user) return showToast('로그인이 필요합니다.');
      const rec = { date:new Date().toISOString(), type: sel.dataset.value, duration, calories };
      saveLocalList('exerciseData', rec);
      try {
        await db.collection('users').doc(user.uid).collection('measurements').doc('exercise')
          .collection('items').add({
            date: new Date(), type: rec.type, duration: rec.duration, calories: rec.calories ?? 0,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
      } catch (e) {
        console.error('save exercise failed:', e);
        showToast('서버 저장 실패(운동)… 잠시 후 다시 시도해주세요.');
      }
      sel.classList.remove('active');
      exerciseDuration.value = '';
      exerciseCalories.value = '';
      exerciseModal.style.display = 'none';
      showToast('운동 기록이 저장되었습니다.');
    });

    privacyPolicyLink?.addEventListener('click', (e) => {
      e.preventDefault();
      showToast('개인정보처리방침 페이지로 이동합니다. (개발 중)');
    });
  }

  // ===== 8) 기타 헬퍼 =====
  function saveLocalList(key, data) {
    const arr = JSON.parse(localStorage.getItem(key) || '[]');
    arr.unshift(data);
    localStorage.setItem(key, JSON.stringify(arr));
  }

  // ===== 9) 인증 리스너 =====
  if (!window.__PAGE_AUTH_WIRED__) {
    window.__PAGE_AUTH_WIRED__ = true;

    if (!auth) {
      initializeTime();
      resetSelectOptions();
      updateUIState();
    } else {
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          // 라우팅은 firebase-init.js에서 처리
          currentUser  = null;
          fastingState = 'idle';
          initializeTime();
          resetSelectOptions();
          updateUIState();
          if (userChip) userChip.style.display = 'none';
          return;
        }

        currentUser = user;

        try {
          const profile  = await getUserDoc(user.uid);

          // >>> 변경된 딱 한 줄: pfNickname 최우선 <<<
          const nickname = profile?.pfNickname ?? profile?.nickname ?? profile?.displayName ?? user.displayName ?? '사용자';
          setUserChip(nickname);

          const savedFasting = profile?.currentFasting;
         if (savedFasting?.startTime) {
  fastingState = 'running';
  selectedStartTime = (savedFasting.startTime.toDate
    ? savedFasting.startTime.toDate()
    : new Date(savedFasting.startTime));
  targetHours = Number(savedFasting.targetHours) || 16;
  if (modelSelect) modelSelect.value = String(targetHours);

  if (fastingInterval) clearInterval(fastingInterval);
  fastingInterval = setInterval(updateTimer, 1000);

  updateTimer();
  updateTimeDisplays();
  updateSelectOptions();
+ initializeTimePicker(); // ← running에서도 saveTimeBtn 리스너 보장
} else {
            fastingState = 'idle';
            initializeTime();
            updateTimeDisplays();
            resetSelectOptions();
          }

          updateUIState();
          if (saltTip)
            saltTip.style.display = (fastingState === 'running' && targetHours >= 48) ? 'block' : 'none';

                      // ▼▼▼ 스플래시 스크린 숨기는 코드 추가 ▼▼▼
          const splashScreen = document.getElementById('splash-screen');
          if (splashScreen) {
            splashScreen.style.display = 'none';
          }
          // ▲▲▲ 스플래시 스크린 숨기는 코드 추가 ▲▲▲

          wireEventsOnce();
        } catch (e) {
          console.error('앱 초기화 중 오류:', e);
          alert('앱 초기화 실패. 새로고침 해주세요.');
        }
      });
    }
  }
});
</script>
